# oldest()

## Change Log

`28.11.2022` - e-objects 1.2.0 перенесена в functions.py. Создана функция start() для запуска на сервере.

## Парсер игровых Telegram каналов 
`Почему oldest?` Не знаю, мне приглянулось название для функции и я даже и не думал, что это окажется отдельным скриптом когда-нибудь.

1. Парсим два игровых канала [ChatWarsAuction](https://t.me/ChatWarsAuction) и [chatwars3](https://t.me/chatwars3).
2. Обрабатываем (совсем чуть-чуть).
   > Под обработкой я подразумеваю удобство записи постов с канала, он просто берет сырой html код, вычленяет оттуда пост.
   > Заменяет в нем переносы строк `<br/>` на слеш `/`, а слеши в тексте заменяет на html аналог, то же самое он делает и с
   > одинарной кавычкой `'` - это конкретно нужно для нормальной записи в базу, а то мало ли что может быть.
3. Дальше он записывает в гугл таблицы эти посты (для каждого сервера отдельную). В вертикальный столбик, все подряд.
4. **Конец?**
   И да, и нет. Это все очень просто и хорошо звучит для небольшого объема информации (в нашем случае постов на каналах).
   Где-то на 300-тысячном посте гугл таблицы начали вести себя неадекватно. Я очень долго не мог помнять в чем проблема.
   Таблицы просто перестали открываться и возвращали ошибку что-то вроде FORBIDDEN или INTERNAL.
   
   Пришлось думать как поступить. Оказалось гугл (похоже на то), хранит вообще все изменения у себя на серверах, причем делает 
   это просто тупо сохраняя каждую новую версию файла где-то у себя. А каждый новый пост в канале это новая запись в таблице.
   И если это делать на одном листе (как и делал я изначально) приводит к тому, что документ начинает занимать там у них КОЛОССАЛЬНО 
   много места. И переставать открываться. Так собственно и получилось, я пытался пересоздавать документ вручную. 
   Но потом он завис настолько, что я потерял базу на 500к лотов аукциона.

   Ну и собственно тогда я и решил обновить систему полностью. Разделил листы в гугл таблицах по 50к лотов, а для новых
   стал создавать отдельную (временную) таблицу, которая при заполнении в 50к лотов копировалась бы в основную и удалялась, а после чего
   создавалась бы новая табличка и так по кругу.

Пришлось плотнее поизучать библиотеку gspread, оказалось там есть некоторые более удобные функции для массовых изменений в таблицах,
что очень потом пригодилось.

Единственным разочарованием стало то, что нет поддержки форматирования таблиц (ну разного рода выравниваний, ширины столбцов), поэтому
пришлось еще поизучать Google API, документация к которому для Python оставляет желать лучшего. Написал кастомный запрос для Google API
и сохранил его в свою библиотеку для удобства, потому что он удобен (objects.properties_json).

`Заметка` на момент написания - в базе eu сервера записано 16 страниц по 50к лотов в каждой и еще одна на подходе.
   это суммарно за два года накопилось 850к лотов. И я думаю, что гугл таблица выдержит.

`Последний апдейт` Добавил описание, доделал помелочи и улучшил секретность. Что-то я намудрил раньше с количеством функций, думаю 
в предь так поступать не буду. Очень удобная штука, я перестал терять лоты, в отличие от старых версии, результатом в целом доволен.

`Может последний апдейт` Обновил e-objects до версии 1.2.0

Ниже привожу ссылки на таблицы с лотами, но решил пока их оставить открытыми только для себя. Потом когда-нибудь опубликую.

Название | Описание
-------- | --------
[eu_storage](https://docs.google.com/spreadsheets/d/14GN4rECr8fTkYWvPXhe2OWjj1REvICKi175QJLmbjYk/edit?usp=sharing) | База лотов EU сервера
[ru_storage](https://docs.google.com/spreadsheets/d/1zb_Vi1X_wjrg6UB6eeXjk-zOs5RW6WUEvTNXAUmkydg/edit?usp=sharing) | База лотов Ru сервера

12.11.2020